//#include <stdlib.h>
#include "xparameters.h"
#include "xdokmean.h"
#include "xaxidma.h"

#define PCLUS 5
#define PDSET 6
#define PNPOI 7
#define PRESU 8
#define PNEWC 9

#define N_FEATURES  50
#define N_CLUSTER 20

#define M1_DONE 0
#define M1_START 1

XDokmean dokmean;
XDokmean_Config *dokmean_cfg;
XAxiDma axiDMA;
XAxiDma_Config *axiDMA_cfg;


int *shared_mem = (int*) 0x40000000;


int initPeripherals(){

	dokmean_cfg = XDokmean_LookupConfig(XPAR_XDOKMEAN_0_DEVICE_ID);
	if(dokmean_cfg){
		int status = XDokmean_CfgInitialize(&dokmean, dokmean_cfg);
		if(status != XST_SUCCESS){
			return 1;
		}
	}

	axiDMA_cfg = XAxiDma_LookupConfig(XPAR_AXIDMA_0_DEVICE_ID);
	if(axiDMA_cfg){
		int stat = XAxiDma_CfgInitialize(&axiDMA,axiDMA_cfg);
		if(stat != XST_SUCCESS){
			return 1;
		}
	}

	XAxiDma_IntrDisable(&axiDMA, XAXIDMA_IRQ_ALL_MASK, XAXIDMA_DEVICE_TO_DMA);
	XAxiDma_IntrDisable(&axiDMA, XAXIDMA_IRQ_ALL_MASK, XAXIDMA_DMA_TO_DEVICE);

	return 0;

}

void kmean(){
	shared_mem[4] = 800;
	int centroid = shared_mem[PCLUS];
	int centroid2 =  shared_mem[PRESU];

	XDokmean_Set_gain(&dokmean, 1);
	XDokmean_Start(&dokmean);

	XAxiDma_SimpleTransfer(&axiDMA, (u32) centroid, N_CLUSTER*N_FEATURES*sizeof(float),XAXIDMA_DMA_TO_DEVICE );
	while(XAxiDma_Busy(&axiDMA, XAXIDMA_DMA_TO_DEVICE));

	XAxiDma_SimpleTransfer(&axiDMA, (u32) centroid2, N_CLUSTER*N_FEATURES*sizeof(float),XAXIDMA_DEVICE_TO_DMA );
	while(XAxiDma_Busy(&axiDMA, XAXIDMA_DEVICE_TO_DMA));

	shared_mem[3] = centroid;
	shared_mem[0] = 1;
	Xil_DCacheFlushRange((u32)shared_mem, 100*sizeof(int));
}
int main(){
	shared_mem[21] = 987;
	shared_mem[1] = 0;
	initPeripherals();
	Xil_DCacheFlushRange((u32)shared_mem, 100*sizeof(int));
	while(1){
		int start = shared_mem[1];
		if(start == 1){
			break;
		}
		usleep(1);
	}
	kmean();

	return 0;
}
